# 文档改写 Agent 系统 - 完整架构与运行原理
## 目录

1. [系统概述](#系统概述)
2. [核心架构](#核心架构)
3. [Agent 设计](#agent-设计)
4. [工作流程](#工作流程)
5. [关键技术](#关键技术)
6. [数据流转](#数据流转)
7. [优化策略](#优化策略)
8. [配置与集成](#配置与集成)

---

## 系统概述

### 项目目标

将技术文档改写成更易懂的版本，专门针对后端开发初学者，同时保存到本地文件和飞书文档中。

### 核心特性

- 🤖 **多 Agent 协作**：MainAgent、SummaryAgent、ReviewerAgent 三层架构
- 📝 **智能改写**：基于用户背景信息的个性化改写
- ✅ **严格评审**：9 个维度的质量评审标准
- 💾 **双重保存**：同时保存到本地文件和飞书文档
- 🔄 **迭代改进**：不满意时自动返回改进建议进行迭代
- ⚡ **Token 优化**：增量改进模式减少 token 消耗

---

## 核心架构

### 系统分层

```
┌─────────────────────────────────────────────────────────┐
│                    用户输入层                             │
│              (文档路径 + 用户背景信息)                    │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                  Supervisor 层                           │
│              (MainAgent 协调者)                          │
│  - 接收用户请求                                         │
│  - 转交给 SummaryAgent                                  │
│  - 协调整个流程                                         │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│              改写与评审循环层                             │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │  SummaryAgent (改写)                             │  │
│  │  - 读取原文档                                    │  │
│  │  - 根据改写原则进行改写                          │  │
│  │  - 输出改写版本到 session                        │  │
│  └──────────────────────────────────────────────────┘  │
│                     │                                   │
│                     ▼                                   │
│  ┌──────────────────────────────────────────────────┐  │
│  │  ReviewerAgent (评审)                            │  │
│  │  - 检查 9 个评审标准                             │  │
│  │  - 满意：保存文档                                │  │
│  │  - 不满意：返回改进建议                          │  │
│  └──────────────────────────────────────────────────┘  │
│                     │                                   │
│         ┌───────────┴───────────┐                      │
│         │                       │                      │
│      满意                    不满意                     │
│         │                       │                      │
│         ▼                       ▼                      │
│      保存文档              返回改进建议                 │
│         │                       │                      │
│         │                  ┌────┴─────┐               │
│         │                  │           │               │
│         │            ┌─────▼──────┐   │               │
│         │            │ SummaryAgent│◄──┘               │
│         │            │ (增量改进)  │                   │
│         │            └─────┬──────┘                   │
│         │                  │                          │
│         │            ┌─────▼──────┐                   │
│         │            │ReviewerAgent│                  │
│         │            │ (再次评审)  │                  │
│         │            └─────┬──────┘                   │
│         │                  │                          │
│         │         ┌────────┴────────┐                │
│         │         │                 │                │
│         │      满意              不满意              │
│         │         │                 │                │
│         └─────────┼─────────────────┘                │
│                   │                                  │
│                   ▼                                  │
│         (最多迭代 5 次)                              │
└────────────────────┬────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                  保存层                                  │
│  - save_document 工具：保存到本地文件                   │
│  - save_to_feishu 工具：保存到飞书文档                 │
│  - satisfied_and_exit 工具：退出循环                   │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                  输出层                                  │
│  - 本地文件：改写文档_[标题].md                         │
│  - 飞书文档：飞书中的同名文档                           │
│  - 用户反馈：改写完成提示                               │
└─────────────────────────────────────────────────────────┘
```

### 组件关系

```
┌─────────────────────────────────────────────────────────┐
│                      main.go                             │
│  - 初始化配置                                           │
│  - 创建 Agent                                           │
│  - 启动 Supervisor                                      │
│  - 处理事件循环                                         │
└──────────────┬──────────────────────────────────────────┘
               │
       ┌───────┴────────┬──────────────┐
       │                │              │
       ▼                ▼              ▼
┌─────────────┐  ┌─────────────┐  ┌──────────────┐
│ MainAgent   │  │SummaryAgent │  │ReviewerAgent │
│ (workflow.go)│  │(summaryAgent│  │(reviewerAgent│
│             │  │.go)         │  │.go)          │
│ - 协调者    │  │             │  │              │
│ - 转交任务  │  │ - 改写专家  │  │ - 评审专家   │
│ - 收集结果  │  │ - 读取文档  │  │ - 检查标准   │
└─────────────┘  │ - 应用原则  │  │ - 返回反馈   │
                 │ - 输出改写  │  │ - 保存文档   │
                 └─────────────┘  └──────────────┘
                       │                │
                       └────────┬───────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
                    ▼                       ▼
            ┌──────────────────┐  ┌──────────────────┐
            │  tools/          │  │  components/     │
            │  - file_writer   │  │  - models        │
            │  - feishu_writer │  │  - state         │
            └──────────────────┘  └──────────────────┘
```

---

## Agent 设计

### 1. MainAgent（协调者）

**职责：** 接收用户请求，协调整个改写流程

**Instruction 关键点：**
```
你是一个文档改写系统的协调者。你的任务是：
1. 接收用户的文档改写请求和文件路径
2. 将任务转交给 SummaryAgent 进行改写
3. SummaryAgent 会使用 read_document 工具读取文件
4. 改写完成后，文档会被自动保存到 markdown 文件中
```

**工具配置：**
- `transfer_to_agent`：转交给 SummaryAgent

**工作流程：**
```
接收请求 → 验证文件存在 → 转交给 SummaryAgent → 等待结果 → 返回完成信息
```

---

### 2. SummaryAgent（改写专家）

**职责：** 根据改写原则对文档进行改写

**核心改写原则（10 个）：**

| 原则 | 说明 | 实现方式 |
|------|------|--------|
| 保留结构 | 保留原文的整体结构和内容 | 不进行大幅删减 |
| 语气调整 | 使用友好、亲切的语气 | 避免生硬学术用语 |
| 详细展开 | 提供充分的细节和上下文 | 解释"是什么、为什么、怎么用" |
| 举例学习 | 提供 2-3 个具体代码示例 | 完整、可运行、有注释 |
| 类比学习 | 使用生活中的类比 | 数据库事务 ≈ 银行转账 |
| 对比学习 | 对比相似或相对的概念 | 使用表格或列表 |
| 图表辅助 | 使用 Mermaid 图表 | 流程图、时序图、类图 |
| 深度讲解 | 讲解原理、机制、坑点 | 性能影响和优化方向 |
| 代码注释 | 每一行代码都有注释 | 清晰、准确、易理解 |
| 章节过渡 | 章节间有过渡性语句 | 说明章节关系 |

**工具配置：**
- `read_document`：读取原始文档

**工作流程：**
```
接收请求 → 读取原文档 → 应用改写原则 → 生成改写版本 → 保存到 session
```

**Token 优化策略：**
- 第一次改写：读取原文件，生成完整改写版本
- 后续改写：基于评审反馈，只修改有问题的部分（增量改进）

---

### 3. ReviewerAgent（评审专家）

**职责：** 严格评审改写后的文档，确保质量达到标准

**9 个评审标准：**

| 标准 | 检查项 | 不满足时的处理 |
|------|--------|--------------|
| 语言易懂性 | 避免生硬用语、使用友好语气 | 要求简化语言 |
| 内容详细度 | 保留完整结构、充分解释概念 | 要求补充细节 |
| 举例和代码 | 提供 2-3 个示例、每行有注释 | 要求添加示例 |
| 类比学习 | 使用生活中的类比 | 要求添加类比 |
| 对比学习 | 对比相似概念、说明选择方案 | 要求添加对比 |
| 图表辅助 | 使用 Mermaid 图表 | 要求添加图表 |
| 深度讲解 | 讲解原理、坑点、性能影响 | 要求深化讲解 |
| 章节过渡 | 章节间有过渡语句 | 要求添加过渡 |
| Markdown 格式 | 正确使用标题、列表、代码块 | 要求修正格式 |

**工具配置：**
- `save_document`：保存到本地文件
- `save_to_feishu`：保存到飞书文档
- `satisfied_and_exit`：退出循环

**工作流程：**
```
接收改写版本 → 逐一检查 9 个标准 → 判断是否满足
                                    ├─ 满意 → 保存文档 → 退出
                                    └─ 不满意 → 返回改进建议 → 转交 SummaryAgent
```

**评审严格性：**
- 只有当所有 9 个标准都完全满足时，才能通过审核
- 如有任何疑虑，宁可要求改进也不要通过
- 特别关注：emoji 过度使用、代码注释不详细、章节过渡缺失

---

## 工作流程

### 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    程序启动                                   │
│  1. 加载配置                                                │
│  2. 创建 MainAgent、SummaryAgent、ReviewerAgent             │
│  3. 使用 Supervisor 编排 Agent                              │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                  用户输入                                    │
│  - 文档路径：./text.md                                      │
│  - 用户背景信息：Java/Golang、MySQL/Kafka/Redis、分布式    │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│              MainAgent 处理                                  │
│  1. 接收用户请求                                            │
│  2. 验证文件存在                                            │
│  3. 转交给 SummaryAgent                                     │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│            SummaryAgent 第 1 次改写                          │
│  1. 使用 read_document 工具读取原文档                       │
│  2. 应用 10 个改写原则                                      │
│  3. 生成改写版本                                            │
│  4. 保存到 session 的 "document_content" 键                 │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│            ReviewerAgent 第 1 次评审                         │
│  1. 获取改写版本                                            │
│  2. 逐一检查 9 个标准                                       │
│  3. 判断是否满足                                            │
└────────────────────┬────────────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
      满意                    不满意
         │                       │
         │                       ▼
         │            ┌──────────────────────────────┐
         │            │  返回改进建议                 │
         │            │  - 标准名称                  │
         │            │  - 问题位置                  │
         │            │  - 改进建议                  │
         │            │  - 示例                      │
         │            └──────────────────────────────┘
         │                       │
         │            ┌──────────▼──────────┐
         │            │ SummaryAgent 增量改进│
         │            │ 1. 不重新读取原文件 │
         │            │ 2. 基于反馈修改    │
         │            │ 3. 只改进有问题部分│
         │            │ 4. 保存到 session  │
         │            └──────────┬──────────┘
         │                       │
         │            ┌──────────▼──────────┐
         │            │ ReviewerAgent 再次评审│
         │            │ 1. 检查改进是否满足 │
         │            │ 2. 最多迭代 5 次   │
         │            └──────────┬──────────┘
         │                       │
         │         ┌─────────────┴─────────────┐
         │         │                           │
         │      满意                        不满意
         │         │                           │
         └─────────┼───────────────────────────┘
                   │
         ┌─────────▼──────────────────────────┐
         │      保存文档                       │
         │  1. save_document 工具             │
         │     → 保存到本地文件               │
         │     → 文件名：改写文档_[标题].md   │
         │  2. save_to_feishu 工具            │
         │     → 保存到飞书文档               │
         │     → 标题与本地文件名一致         │
         │  3. satisfied_and_exit 工具        │
         │     → 退出循环                     │
         └─────────┬──────────────────────────┘
                   │
         ┌─────────▼──────────────────────────┐
         │      任务完成                       │
         │  - 本地文件已生成                  │
         │  - 飞书文档已创建                  │
         │  - 用户可访问两个版本              │
         └──────────────────────────────────────┘
```

### 关键决策点

#### 1. 改写质量判断
```
ReviewerAgent 检查 9 个标准
    ├─ 所有标准都满足 → 通过审核 → 保存文档
    └─ 任何标准不满足 → 返回改进建议 → 继续改进
```

#### 2. 迭代控制
```
最多迭代 5 次
    ├─ 第 1-4 次：不满足 → 继续改进
    └─ 第 5 次：无论满足与否 → 保存文档（防止无限循环）
```

#### 3. Token 优化
```
第一次改写：读取原文件 + 完整改写
后续改写：基于反馈 + 增量改进（不重新读取原文件）
```

---

## 关键技术

### 1. Eino ADK 框架

**核心概念：**
- **Agent**：自主决策的智能体
- **Tool**：Agent 可以调用的工具
- **LoopAgent**：支持循环迭代的 Agent
- **Supervisor**：协调多个 Agent 的执行

**使用示例：**
```go
// 创建 ChatModelAgent
agent := adk.NewChatModelAgent(ctx, &adk.ChatModelAgentConfig{
    Name:        "MyAgent",
    Description: "Agent 描述",
    Instruction: "Agent 指令",
    Model:       llmModel,
    ToolsConfig: adk.ToolsConfig{
        ToolsNodeConfig: compose.ToolsNodeConfig{
            Tools: []tool.BaseTool{tool1, tool2},
        },
        ReturnDirectly: map[string]bool{
            "tool1": true,
        },
    },
})

// 创建 LoopAgent（支持循环）
loopAgent := adk.NewLoopAgent(ctx, &adk.LoopAgentConfig{
    Name:           "MyLoopAgent",
    SubAgents:      []adk.Agent{agent1, agent2},
    MaxIterations:  5,
})

// 创建 Supervisor（协调多个 Agent）
supervisor := supervisor.New(ctx, &supervisor.Config{
    Supervisor: mainAgent,
    SubAgents:  []adk.Agent{subAgent1, subAgent2},
})
```

### 2. LLM 模型集成

**使用的模型：**
- **MainAgent**：Qwen Turbo（快速响应）
- **SummaryAgent**：Qwen 3 Max Preview（高质量改写）
- **ReviewerAgent**：Qwen 3 Max Preview（严格评审）

**模型选择原因：**
- Turbo：快速响应，适合协调任务
- Max Preview：高质量输出，适合改写和评审

### 3. 工具系统

**工具类型：**

| 工具 | 所属 Agent | 功能 | 返回值 |
|------|-----------|------|--------|
| read_document | SummaryAgent | 读取原始文档 | 文档内容 |
| save_document | ReviewerAgent | 保存到本地文件 | 文件路径 |
| save_to_feishu | ReviewerAgent | 保存到飞书 | 飞书链接 |
| satisfied_and_exit | ReviewerAgent | 退出循环 | 完成信息 |

**工具实现方式：**
```go
// 使用 InferTool 创建工具
tool := utils.InferTool(
    "tool_name",
    "tool_description",
    func(ctx context.Context, input *InputType) (string, error) {
        // 工具实现逻辑
        return result, nil
    },
)
```

### 4. Session 状态管理

**状态存储：**
```
Session 中的关键键值：
- "document_content"：改写后的文档内容
- 用于在 Agent 之间传递数据
```

**数据流转：**
```
SummaryAgent 改写 → 保存到 session["document_content"]
                    ↓
ReviewerAgent 评审 → 读取 session["document_content"]
                    ↓
ReviewerAgent 保存 → 使用 session["document_content"] 保存文档
```

---

## 数据流转

### 完整数据流

```
┌─────────────────────────────────────────────────────────┐
│                  用户输入                                 │
│  {                                                       │
│    "filepath": "./text.md",                             │
│    "user_background": {                                 │
│      "languages": ["Java", "Golang"],                   │
│      "middleware": ["MySQL", "Kafka", "Redis"],         │
│      "architecture": "distributed_design"               │
│    }                                                     │
│  }                                                       │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│              MainAgent 处理                              │
│  输入：用户请求                                         │
│  处理：验证文件、转交任务                               │
│  输出：转交给 SummaryAgent                              │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│            SummaryAgent 改写                             │
│  输入：文件路径                                         │
│  处理：                                                 │
│    1. read_document("./text.md")                        │
│       → 获取原文档内容                                  │
│    2. 应用 10 个改写原则                                │
│    3. 生成改写版本                                      │
│  输出：改写后的文档内容                                 │
│  存储：session["document_content"] = 改写内容           │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│            ReviewerAgent 评审                            │
│  输入：session["document_content"]                      │
│  处理：                                                 │
│    1. 检查 9 个评审标准                                 │
│    2. 生成评审结果                                      │
│  输出：                                                 │
│    - 满意：保存信息                                     │
│    - 不满意：改进建议                                   │
└────────────────────┬────────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
      满意                    不满意
         │                       │
         │                       ▼
         │            ┌──────────────────────┐
         │            │  改进建议             │
         │            │  {                   │
         │            │    "标准": "...",    │
         │            │    "问题位置": "...",│
         │            │    "改进建议": "...",│
         │            │    "示例": "..."     │
         │            │  }                   │
         │            └──────────┬───────────┘
         │                       │
         │            ┌──────────▼───────────┐
         │            │ SummaryAgent 增量改进 │
         │            │ 输入：改进建议       │
         │            │ 处理：修改有问题部分 │
         │            │ 输出：改进后的内容   │
         │            │ 存储：更新 session   │
         │            └──────────┬───────────┘
         │                       │
         │            ┌──────────▼───────────┐
         │            │ ReviewerAgent 再次评审│
         │            │ 输入：改进后的内容   │
         │            │ 处理：重新检查标准   │
         │            │ 输出：评审结果       │
         │            └──────────┬───────────┘
         │                       │
         └───────────┬───────────┘
                     │
         ┌───────────▼──────────────────┐
         │      保存文档                  │
         │  1. save_document()           │
         │     输入：改写内容            │
         │     输出：本地文件路径        │
         │  2. save_to_feishu()          │
         │     输入：改写内容 + 标题     │
         │     输出：飞书文档链接        │
         │  3. satisfied_and_exit()      │
         │     输入：完成信息            │
         │     输出：退出循环            │
         └───────────┬──────────────────┘
                     │
         ┌───────────▼──────────────────┐
         │      最终输出                  │
         │  {                            │
         │    "local_file": "改写文档_...",
         │    "feishu_link": "https://...",
         │    "status": "completed"      │
         │  }                            │
         └──────────────────────────────┘
```

### 内存中的数据结构

```
Session 状态：
{
  "document_content": "改写后的文档内容",
  "iteration_count": 1,
  "user_background": {
    "languages": ["Java", "Golang"],
    "middleware": ["MySQL", "Kafka", "Redis"],
    "architecture": "distributed_design"
  }
}

Agent 消息历史：
[
  {
    "role": "user",
    "content": "请改写这份文档..."
  },
  {
    "role": "assistant",
    "content": "改写后的文档内容..."
  },
  {
    "role": "user",
    "content": "请改进以下部分..."
  },
  {
    "role": "assistant",
    "content": "改进后的内容..."
  }
]
```

---

## 优化策略

### 1. Token 优化

**问题：** 每次改写都重新读取原文件，消耗大量 token

**解决方案：**
```
第一次改写：
  - 读取原文件（消耗 token）
  - 完整改写（消耗 token）
  - 保存到 session

后续改写（增量改进）：
  - 不重新读取原文件（节省 token）
  - 基于评审反馈，只修改有问题的部分
  - 更新 session

效果：
  - 第一次：完整改写，token 消耗较多
  - 第二次：增量改进，token 消耗减少 50-70%
  - 第三次及以后：继续减少 token 消耗
```

### 2. 质量优化

**改写质量提升：**
- 10 个改写原则确保内容质量
- 9 个评审标准确保改写质量
- 最多 5 次迭代确保最终质量

**评审严格性：**
- 所有 9 个标准都必须满足
- 特别关注常见问题：emoji 过度、代码注释不详细、章节过渡缺失
- 如有疑虑，宁可要求改进也不要通过

### 3. 用户体验优化

**双重保存：**
- 本地文件：方便本地查看和编辑
- 飞书文档：方便团队协作和分享

**清晰的文件名：**
- 格式：`改写文档_[标题].md`
- 示例：`改写文档_技术文档.md`

**实时反馈：**
- 显示改写进度
- 显示评审结果
- 显示保存位置

---

## 配置与集成

### 1. 用户背景信息

```
编程语言：
  - Java：简单后端开发
  - Golang：简单后端开发

中间件经验：
  - MySQL：基本使用
  - Kafka：基本使用
  - Redis：基本使用

架构知识：
  - 分布式设计：基本概念

学习阶段：
  - 从零开始学习和梳理后端开发框架
```

**用途：** 帮助 LLM 调整改写难度和示例选择

### 2. 改写原则配置

```
在 SummaryAgent 的 Instruction 中配置：
- 保留结构：不进行大幅删减
- 语气调整：友好、亲切
- 详细展开：充分解释
- 举例学习：2-3 个示例
- 类比学习：生活中的类比
- 对比学习：表格或列表
- 图表辅助：Mermaid 图表
- 深度讲解：原理、机制、坑点
- 代码注释：每一行都有注释
- 章节过渡：过渡性语句
```

### 3. 评审标准配置

```
在 ReviewerAgent 的 Instruction 中配置：
- 9 个评审标准
- 每个标准的检查项
- 不满足时的处理方式
- 特别关注的常见问题
```

### 4. 飞书集成配置

```
飞书应用凭证：
  - App ID: cli_a7a0822d4f71100d
  - App Secret: UerLooRg7uvYVTYO1eoUufr65EOTHuBd
  - User Token: u-dbl.CVTu50WGLmzfWkcFeh4l5shRlgMPOaayFxw00JUy

默认文件夹：
  - Folder Token: HQjyfawL2lpgq9diKYwcTLl5nmY

工具配置：
  - save_to_feishu：创建飞书文档
  - 返回飞书文档链接
```

---

## 总结

### 系统特点

1. **多层次架构**
   - MainAgent：协调者
   - SummaryAgent：改写专家
   - ReviewerAgent：评审专家

2. **智能改写**
   - 10 个改写原则
   - 基于用户背景信息
   - 个性化改写

3. **严格评审**
   - 9 个评审标准
   - 最多 5 次迭代
   - 确保质量

4. **双重保存**
   - 本地文件
   - 飞书文档

5. **Token 优化**
   - 增量改进模式
   - 减少 token 消耗

### 运行流程总结

```
用户输入 → MainAgent 协调 → SummaryAgent 改写 → ReviewerAgent 评审
                                                    ├─ 满意 → 保存文档 → 完成
                                                    └─ 不满意 → 返回反馈 → 继续改进
```

### 关键成功因素

1. **清晰的 Instruction**：每个 Agent 都有明确的职责和指导
2. **有效的工具**：工具设计简洁高效
3. **严格的评审**：确保改写质量
4. **智能的迭代**：基于反馈进行增量改进
5. **用户友好**：双重保存、清晰的文件名、实时反馈

---

## 附录：文件结构

```
eino_test/
├── main.go                          # 主程序入口
├── agent/
│   ├── workflow.go                  # MainAgent 实现
│   ├── summaryAgent.go              # SummaryAgent 实现
│   └── reviewerAgent.go             # ReviewerAgent 实现
├── tools/
│   ├── file_writer.go               # 本地文件保存工具
│   ├── feishu_writer.go             # 飞书文档保存工具
│   └── feishu_test.go               # 飞书 SDK 测试
├── components/
│   ├── models/                      # LLM 模型配置
│   └── state/                       # 状态管理
├── common/
│   ├── constant/                    # 常量定义
│   └── utils/                       # 工具函数
└── config/                          # 配置文件
```

---

**文档版本：** 1.0  
**最后更新：** 2025-12-15  
**作者：** AI Agent 系统设计团队
